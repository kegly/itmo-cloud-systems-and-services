# Плохие практики при написании docker-compose

При написании docker-compose выделяют следующие плохие практики:

- Использовать sleep для ожидания другого контейнера. Если один контейнер зависит от другого и должен быть запущен после другого (например, сервис и база данных), то необходимо выражать зависимость с помощью depends_on. Использование sleep и других подобных методов для ожидания запуска другого контейнера является плохой практикой, т. к. не предоставляет никаких гарантий, что зависимый контейнер будет действительно запущен.
- Использовать общую сеть между контейнерами. Если контейнерам для работы не требуется быть в одной сети (например, фронтенд и бэкенд), то их следует изолировать с отдельные сети с помощью networks. Использование общей сети может привести к проблемам с безопасностью.
- Занимать порты хоста на адресе 0.0.0.0. Зачастую необходимо прокинуть порт с контейнера на хост, для этого нередко используют запись 8000:8000. Однако такая запись является ошибочной, потому что в таком случае контейнер может начать прослушивать все входящие запросы на хост, что может привести к проблемам с безопасностью. Вместо этого следует использовать запись 127.0.0.1:8000:8000, чтобы ограничить прослушивание только на локальном адресе.
- Хранить чувствительные данные внутри конфига. Это является небезопасной практикой, т. к. в случае утечки конфига утекут и все чувствительные данные вместе с ним. Вместо этого следует использовать систему секретов Docker.
- Хранить важные данные в контейнере. В любой момент времени контейнер может быть остановлен и удален. В таком случае все данные, хранимые в контейнере, будут безвозвратно удалены. Чтобы такого не произошло, важные данные, которые должны сохраниться в случае удаления контейнера, необходимо хранить томах хранения данных.


Далее приведен пример плохого docker-compose:

```bad-docker-compose.yml
version: '3'

services:
  frontend:
    image: nginx
    ports:
      - "3000:3000"
    volumes:
      - .:/app
    depends_on:
      - backend

  backend:
    image: python
    ports:
      - "8000:8000"
    volumes:
      - .:/app

  db:
    image: postgres
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: insecurepassword
    ports:
      - "5432:5432"
```

В нем не выражена зависимость между контейнерами, хотя бэкенд должен запускаться после базы данных, а фронтенд — после бэкенда. В нем используется общая сеть для фронтенда, бэкенда и базы данных, хотя логически база данных, относящаяся только к бэкенду, должна быть изолирована от фронтенда. Также контейнеры фронтенда и бэкенда занимают порты на адресе 0.0.0.0 вместо локального адреса. В конфиге секретные данные, такие как пароль от базы данных, хранятся явно. Вдобавок ко всему, данные, которые сохраняет PostgreSQL, хранятся в самом контейнере, а не в томах хранения данных.

Исправив эти недостатки, получим следующий docker-compose:

```docker-compose.yml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
    ports:
      - 127.0.0.1:3000:3000
    networks:
      - frontend_network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 5

  backend:
    build:
      context: ./backend
    ports:
      - 127.0.0.1:8000:8000
    networks:
      - backend_network
      - db_network
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  db:
    image: postgres:16.0
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD_FILE: /run/secrets/db_root_password
    networks:
      - db_network
    secrets:
      - db_root_password
    healthcheck:
      test: ["CMD", "pg_isready -U myuser -d mydb"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  db_network:
    driver: bridge
  backend_network:
    driver: bridge
  frontend_network:
    driver: bridge

secrets:
  db_root_password:
    file: ./secrets/db_root_password
```

В нем выражена зависимость между контейнерами с помощью depends_on, контейнеры разделены на изолированные сети, проброс портов сделан только на локальный адрес. Также в конфиге не хранятся чувствительные данные: вместо этого используются секреты Docker. Вдобавок ко всему, данные PostgreSQL сохраняются в том, а в контейнерах настроен healthcheck.

# Заключение

В данной лабораторной работе были рассмотрены плохие практики при написании docker-compose. На примере конкретного docker-compose эти практики были разобраны и исправлены.
